#!/bin/bash
set -e

if [[ $# -ne 1 ]] ; then
    echo "Usage: `basename $0` /path/to/f90/file"
    exit 0
fi

update_mlir_test=/home/rpenacob/llvm-mono/mlir/utils/generate-test-checks.py

ret=$(head -n 1 $1)

if [ "$ret" = "! NOTE: Assertions have been autogenerated by $update_mlir_test" ]; then
  update=1
  echo "LOG: Updating"
else
  update=0
  echo "LOG: First time autogenerating test info"
fi

input=$(cat $1)

IFS=" " read -a runline <<< $(grep -w "! RUN:" $1)
# remove "! RUN:"
runline=("${runline[@]:2}")

foundFileCheck=-1
prefix=CHECK
# try to remove FileCheck which is supposed to be piped at the end of the command
# replace %s by the source file
for (( j=0; j<${#runline[@]}; j++ ));
do
  if [ "${runline[$j]}" = "FileCheck" ]; then
    foundFileCheck=$j
    for (( k=$j; k<${#runline[@]}; k++ ));
    do
      if [[ "${runline[$k]}" = --check-prefix=* ]]; then
        IFS="=" read -a checkPrefix <<< "${runline[$k]}"
        if [[ -z "${checkPrefix[1]}" ]]; then
          echo "ERROR: found --check-prefix= but no prefix found"
          exit 1
        fi
        prefix="${checkPrefix[1]}"
        break
      fi
    done
  elif [[ "${runline[$j]}" = "%s" ]]; then
    runline[$j]="$1"
  fi
done
if [ "${foundFileCheck}" != "-1" ]; then
  echo "LOG: found FileCheck, removing from there till the end of the runline"
  runline=("${runline[@]:0:${foundFileCheck}-1}")
fi

tmpfile=/tmp/test.mlir
echo "${runline[*]} > ${tmpfile}"
$(eval ${runline[*]} > ${tmpfile})

echo "${update_mlir_test} ${tmpfile} --check-prefix ${prefix}"
#ret=$(${update_mlir_test} ${tmpfile} --check-prefix ${prefix})

tmpfile1=/tmp/test1.f90
if [ "$update" = 1 ]; then
  ret=$(grep -n "! ${prefix}" $1 | head -n 1 | cut -d ':' -f 1)
  ret=$(("$(wc -l $1 | cut -d ' ' -f 1)" - $ret + 2))
  ret=$(tac $1 | tail -n +$ret | tac > $tmpfile1)
  ret=$(${update_mlir_test} ${tmpfile} --check-prefix ${prefix} --starts_from_scope 1 | tail -n +9 >> $tmpfile1)
  ret=$(sed -i "s|// $prefix|! $prefix|g" $tmpfile1)
  ret=$(sed -i "s|\.\*|\[-0-9A-Za-z._\]+|g" $tmpfile1)
  mv $tmpfile1 $1
else
  echo "! NOTE: Assertions have been autogenerated by $update_mlir_test" > $tmpfile1
  cat $1 >> $tmpfile1
  ret=$(${update_mlir_test} ${tmpfile} --check-prefix ${prefix} --starts_from_scope 0 | tail -n +9 >> $tmpfile1)
  ret=$(sed -i "s|// $prefix|! $prefix|g" $tmpfile1)
  ret=$(sed -i "s|\.\*|\[-0-9A-Za-z._\]+|g" $tmpfile1)
  mv $tmpfile1 $1
fi

