! NOTE: Assertions have been autogenerated by /home/rpenacob/llvm-mono/mlir/utils/generate-test-checks.py
! This test checks lowering of OmpSs-2 taskloop do Directive.

! RUN: bbc -fompss-2 %s -o - | fir-opt --convert-hlfir-to-fir | fir-opt --cg-rewrite | fir-opt --fir-to-llvm-ir 2>&1 |  FileCheck %s --check-prefix=LLVMIRDialect

program task
    INTEGER :: I
    INTEGER :: J

    ! chunksize clause
    !$OSS TASKLOOP DO CHUNKSIZE(50)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! grainsize clause
    !$OSS TASKLOOP DO GRAINSIZE(60)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! No clauses
    !$OSS TASKLOOP DO
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! if clause
    !$OSS TASKLOOP DO IF(I .EQ. 3)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! final clause
    !$OSS TASKLOOP DO FINAL(I .EQ. 3)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! cost clause
    !$OSS TASKLOOP DO COST(3)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! priority clause
    !$OSS TASKLOOP DO PRIORITY(3)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! default clause
    !$OSS TASKLOOP DO DEFAULT(SHARED)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! private clause
    !$OSS TASKLOOP DO PRIVATE(I)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! firstprivate clause
    !$OSS TASKLOOP DO FIRSTPRIVATE(I)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! shared clause
    !$OSS TASKLOOP DO SHARED(I)
    DO J=1,10
    END DO
    !$OSS END TASKLOOP DO

    ! In MLIR we can have a branch
    ! whose successors are the same block
    ! with diferent arguments. This is not allowed
    ! in LLVMDialect. Check this
    ! UPDATE: This does not happen anymore, but a
    ! manual mlir code could be written
    ! See mlir/test/Conversion/OmpSsToLLVM/distinc-successors.mlir
    ! !$OSS TASKLOOP DO PRIVATE(I)
    ! DO J=1,10
    !     IF (I .EQ. 1) THEN
    !         I = 1
    !     ELSE IF (I .EQ. 2) THEN
    !         I = 2
    !     ELSE
    !         I = 3
    !     END IF
    ! END DO
    ! !$OSS END TASKLOOP DO

end program


! LLVMIRDialect-LABEL:   llvm.func @_QQmain() attributes {fir.bindc_name = "task"} {
! LLVMIRDialect:           %[[VAL_0:[-0-9A-Za-z._]+]] = llvm.mlir.constant(3 : i32) : i32
! LLVMIRDialect:           %[[VAL_1:[-0-9A-Za-z._]+]] = llvm.mlir.constant(60 : i32) : i32
! LLVMIRDialect:           %[[VAL_2:[-0-9A-Za-z._]+]] = llvm.mlir.constant(1 : i64) : i64
! LLVMIRDialect:           %[[VAL_3:[-0-9A-Za-z._]+]] = llvm.mlir.constant(10 : i32) : i32
! LLVMIRDialect:           %[[VAL_4:[-0-9A-Za-z._]+]] = llvm.mlir.constant(1 : i32) : i32
! LLVMIRDialect:           %[[VAL_5:[-0-9A-Za-z._]+]] = llvm.mlir.constant(50 : i32) : i32
! LLVMIRDialect:           %[[VAL_6:[-0-9A-Za-z._]+]] = llvm.mlir.constant(1 : i64) : i64
! LLVMIRDialect:           %[[VAL_7:[-0-9A-Za-z._]+]] = llvm.alloca %[[VAL_6]] x i32 {bindc_name = "i"} : (i64) -> !llvm.ptr
! LLVMIRDialect:           %[[VAL_8:[-0-9A-Za-z._]+]] = llvm.mlir.constant(1 : i64) : i64
! LLVMIRDialect:           %[[VAL_9:[-0-9A-Za-z._]+]] = llvm.alloca %[[VAL_8]] x i32 {bindc_name = "j"} : (i64) -> !llvm.ptr
! LLVMIRDialect:           %[[VAL_10:[-0-9A-Za-z._]+]] = llvm.mlir.undef : i32
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) chunksize(%[[VAL_5]] : i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) grainsize(%[[VAL_1]] : i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           %[[VAL_11:[-0-9A-Za-z._]+]] = llvm.load %[[VAL_7]] : !llvm.ptr -> i32
! LLVMIRDialect:           %[[VAL_12:[-0-9A-Za-z._]+]] = llvm.icmp "eq" %[[VAL_11]], %[[VAL_0]] : i32
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) if(%[[VAL_12]] : i1) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           %[[VAL_13:[-0-9A-Za-z._]+]] = llvm.load %[[VAL_7]] : !llvm.ptr -> i32
! LLVMIRDialect:           %[[VAL_14:[-0-9A-Za-z._]+]] = llvm.icmp "eq" %[[VAL_13]], %[[VAL_0]] : i32
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) final(%[[VAL_14]] : i1) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) cost(%[[VAL_0]] : i32) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) priority(%[[VAL_0]] : i32) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) default( defshared) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) private(%[[VAL_7]], %[[VAL_7]], %[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr, !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]], %[[VAL_10]], %[[VAL_10]] : i32, i32, i32, i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) firstprivate(%[[VAL_7]], %[[VAL_7]] : !llvm.ptr, !llvm.ptr) firstprivate_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           oss.taskloop_for lower_bound(%[[VAL_4]] : i32) upper_bound(%[[VAL_3]] : i32) step(%[[VAL_4]] : i32) loop_type(%[[VAL_2]] : i64) ind_var(%[[VAL_9]] : !llvm.ptr) private(%[[VAL_9]], %[[VAL_9]] : !llvm.ptr, !llvm.ptr) private_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) shared(%[[VAL_7]], %[[VAL_7]] : !llvm.ptr, !llvm.ptr) shared_type(%[[VAL_10]], %[[VAL_10]] : i32, i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           llvm.return
! LLVMIRDialect:         }

! LLVMIRDialect-LABEL:   llvm.mlir.global external constant @_QQEnvironmentDefaults() {addr_space = 0 : i32} : !llvm.ptr {
! LLVMIRDialect:           %[[VAL_0:[-0-9A-Za-z._]+]] = llvm.mlir.zero : !llvm.ptr
! LLVMIRDialect:           llvm.return %[[VAL_0]] : !llvm.ptr
! LLVMIRDialect:         }

