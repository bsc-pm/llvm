! NOTE: Assertions have been autogenerated by /home/rpenacob/llvm-mono/mlir/utils/generate-test-checks.py
! This test checks lowering of OmpSs-2 like dependencies.

! RUN: flang-new -fc1 -flang-deprecated-no-hlfir -fompss-2 -emit-llvm  -mmlir --mlir-print-ir-after-all %s -o /dev/null |& tail -n +$(flang-new -fc1 -flang-deprecated-no-hlfir -fompss-2 -emit-llvm  -mmlir --mlir-print-ir-after-all %s -o /dev/null |& grep -n FIRToLLVMLowering | cut -f1 -d:) | FileCheck %s --check-prefix=LLVMIRDialect

program task
    IMPLICIT NONE
    INTEGER :: I

    !$OSS TASK OUT(I)
    CONTINUE
    !$OSS END TASK
end

! LLVMIRDialect-LABEL:   llvm.func @_QQmain() attributes {fir.bindc_name = "task"} {
! LLVMIRDialect:           %[[VAL_0:[-0-9A-Za-z._]+]] = llvm.mlir.constant(1 : i64) : i64
! LLVMIRDialect:           %[[VAL_1:[-0-9A-Za-z._]+]] = llvm.alloca %[[VAL_0]] x i32 {bindc_name = "i"} : (i64) -> !llvm.ptr
! LLVMIRDialect:           %[[VAL_2:[-0-9A-Za-z._]+]] = llvm.mlir.undef : i32
! LLVMIRDialect:           %[[VAL_3:[-0-9A-Za-z._]+]] = oss.dependency base(%[[VAL_1]] : !llvm.ptr) function(@compute.dep0) arguments(%[[VAL_1]] : !llvm.ptr) -> i32
! LLVMIRDialect:           oss.task shared(%[[VAL_1]] : !llvm.ptr) shared_type(%[[VAL_2]] : i32) out(%[[VAL_3]] : i32) {
! LLVMIRDialect:             oss.terminator
! LLVMIRDialect:           }
! LLVMIRDialect:           llvm.return
! LLVMIRDialect:         }

! LLVMIRDialect-LABEL:   llvm.func @compute.dep0(
! LLVMIRDialect-SAME:                            %[[VAL_0:[-0-9A-Za-z._]+]]: !llvm.ptr) -> !llvm.struct<(ptr, i64, i64, i64)> {
! LLVMIRDialect:           %[[VAL_1:[-0-9A-Za-z._]+]] = llvm.mlir.constant(4 : i64) : i64
! LLVMIRDialect:           %[[VAL_2:[-0-9A-Za-z._]+]] = llvm.mlir.constant(0 : i64) : i64
! LLVMIRDialect:           %[[VAL_3:[-0-9A-Za-z._]+]] = llvm.mlir.undef : !llvm.struct<(ptr, i64, i64, i64)>
! LLVMIRDialect:           %[[VAL_4:[-0-9A-Za-z._]+]] = llvm.insertvalue %[[VAL_0]], %[[VAL_3]][0] : !llvm.struct<(ptr, i64, i64, i64)>
! LLVMIRDialect:           %[[VAL_5:[-0-9A-Za-z._]+]] = llvm.insertvalue %[[VAL_1]], %[[VAL_4]][1] : !llvm.struct<(ptr, i64, i64, i64)>
! LLVMIRDialect:           %[[VAL_6:[-0-9A-Za-z._]+]] = llvm.insertvalue %[[VAL_2]], %[[VAL_5]][2] : !llvm.struct<(ptr, i64, i64, i64)>
! LLVMIRDialect:           %[[VAL_7:[-0-9A-Za-z._]+]] = llvm.insertvalue %[[VAL_1]], %[[VAL_6]][3] : !llvm.struct<(ptr, i64, i64, i64)>
! LLVMIRDialect:           llvm.return %[[VAL_7]] : !llvm.struct<(ptr, i64, i64, i64)>
! LLVMIRDialect:         }

