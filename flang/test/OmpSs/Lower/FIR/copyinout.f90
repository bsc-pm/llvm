! NOTE: Assertions have been autogenerated by /home/rpenacob/llvm-mono/mlir/utils/generate-test-checks.py
! RUN: bbc -fompss-2 -emit-fir %s -o - | FileCheck %s --check-prefix=FIRDialect
subroutine test_intent_in(x)
  real :: x(:)
  call bar_intent_in(x)
!$oss taskwait
end subroutine

!$oss task
subroutine bar_intent_in(x)
  real, intent(in) :: x(5)
end subroutine

subroutine test_intent_out(x)
  real :: x(:)
  call bar_intent_out(x)
!$oss taskwait
end subroutine

!$oss task
subroutine bar_intent_out(x)
  real, intent(out) :: x(5)
end subroutine



! FIRDialect-LABEL:   func.func @_QPtest_intent_in(
! FIRDialect-SAME:                                 %[[VAL_0:[-0-9A-Za-z._]+]]: !fir.box<!fir.array<?xf32>> {fir.bindc_name = "x"}) {
! FIRDialect:           %[[VAL_1:[-0-9A-Za-z._]+]] = fir.alloca !fir.box<!fir.array<?xf32>>
! FIRDialect:           %[[VAL_2:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_0]] : (!fir.box<!fir.array<?xf32>>) -> !fir.box<none>
! FIRDialect:           %[[VAL_3:[-0-9A-Za-z._]+]] = fir.call @_FortranAIsContiguous(%[[VAL_2]]) fastmath<contract> : (!fir.box<none>) -> i1
! FIRDialect:           %[[VAL_4:[-0-9A-Za-z._]+]] = fir.if %[[VAL_3]] -> (!fir.heap<!fir.array<?xf32>>) {
! FIRDialect:             %[[VAL_5:[-0-9A-Za-z._]+]] = fir.box_addr %[[VAL_0]] : (!fir.box<!fir.array<?xf32>>) -> !fir.heap<!fir.array<?xf32>>
! FIRDialect:             fir.result %[[VAL_5]] : !fir.heap<!fir.array<?xf32>>
! FIRDialect:           } else {
! FIRDialect:             %[[VAL_6:[-0-9A-Za-z._]+]] = arith.constant 0 : index
! FIRDialect:             %[[VAL_7:[-0-9A-Za-z._]+]]:3 = fir.box_dims %[[VAL_0]], %[[VAL_6]] : (!fir.box<!fir.array<?xf32>>, index) -> (index, index, index)
! FIRDialect:             %[[VAL_8:[-0-9A-Za-z._]+]] = fir.allocmem !fir.array<?xf32>, %[[VAL_7]]#1 {uniq_name = ".copyinout"}
! FIRDialect:             %[[VAL_9:[-0-9A-Za-z._]+]] = fir.shape %[[VAL_7]]#1 : (index) -> !fir.shape<1>
! FIRDialect:             %[[VAL_10:[-0-9A-Za-z._]+]] = fir.embox %[[VAL_8]](%[[VAL_9]]) : (!fir.heap<!fir.array<?xf32>>, !fir.shape<1>) -> !fir.box<!fir.array<?xf32>>
! FIRDialect:             fir.store %[[VAL_10]] to %[[VAL_1]] : !fir.ref<!fir.box<!fir.array<?xf32>>>
! FIRDialect:             %[[VAL_11:[-0-9A-Za-z._]+]] = fir.address_of(@_QQcl.8f2d0f6342c0c913c244b419469ae9a0) : !fir.ref<!fir.char<1,66>>
! FIRDialect:             %[[VAL_12:[-0-9A-Za-z._]+]] = arith.constant 5 : i32
! FIRDialect:             %[[VAL_13:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_1]] : (!fir.ref<!fir.box<!fir.array<?xf32>>>) -> !fir.ref<!fir.box<none>>
! FIRDialect:             %[[VAL_14:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_0]] : (!fir.box<!fir.array<?xf32>>) -> !fir.box<none>
! FIRDialect:             %[[VAL_15:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_11]] : (!fir.ref<!fir.char<1,66>>) -> !fir.ref<i8>
! FIRDialect:             %[[VAL_16:[-0-9A-Za-z._]+]] = fir.call @_FortranAAssignTemporary(%[[VAL_13]], %[[VAL_14]], %[[VAL_15]], %[[VAL_12]]) fastmath<contract> : (!fir.ref<!fir.box<none>>, !fir.box<none>, !fir.ref<i8>, i32) -> none
! FIRDialect:             fir.result %[[VAL_8]] : !fir.heap<!fir.array<?xf32>>
! FIRDialect:           }
! FIRDialect:           %[[VAL_17:[-0-9A-Za-z._]+]] = arith.constant 0 : index
! FIRDialect:           %[[VAL_18:[-0-9A-Za-z._]+]]:3 = fir.box_dims %[[VAL_0]], %[[VAL_17]] : (!fir.box<!fir.array<?xf32>>, index) -> (index, index, index)
! FIRDialect:           %[[VAL_19:[-0-9A-Za-z._]+]] = arith.constant false
! FIRDialect:           %[[VAL_20:[-0-9A-Za-z._]+]] = arith.cmpi eq, %[[VAL_3]], %[[VAL_19]] : i1
! FIRDialect:           oss.task shared(%[[VAL_21:[-0-9A-Za-z._]+]] : !fir.heap<!fir.array<?xf32>>) captures(%[[VAL_18]]#1, %[[VAL_20]] : index, i1) {
! FIRDialect:             %[[VAL_22:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_21]] : (!fir.heap<!fir.array<?xf32>>) -> !fir.ref<!fir.array<5xf32>>
! FIRDialect:             fir.call @_QPbar_intent_in(%[[VAL_22]]) fastmath<contract> : (!fir.ref<!fir.array<5xf32>>) -> ()
! FIRDialect:             fir.if %[[VAL_20]] {
! FIRDialect:               fir.freemem %[[VAL_21]] : !fir.heap<!fir.array<?xf32>>
! FIRDialect:             }
! FIRDialect:             oss.terminator
! FIRDialect:           }
! FIRDialect:           oss.taskwait
! FIRDialect:           return
! FIRDialect:         }

! FIRDialect-LABEL:   func.func @_QPbar_intent_in(
! FIRDialect-SAME:                                %[[VAL_0:[-0-9A-Za-z._]+]]: !fir.ref<!fir.array<5xf32>> {fir.bindc_name = "x"}) {
! FIRDialect:           return
! FIRDialect:         }

! FIRDialect-LABEL:   func.func @_QPtest_intent_out(
! FIRDialect-SAME:                                  %[[VAL_0:[-0-9A-Za-z._]+]]: !fir.box<!fir.array<?xf32>> {fir.bindc_name = "x"}) {
! FIRDialect:           %[[VAL_1:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_0]] : (!fir.box<!fir.array<?xf32>>) -> !fir.box<none>
! FIRDialect:           %[[VAL_2:[-0-9A-Za-z._]+]] = fir.call @_FortranAIsContiguous(%[[VAL_1]]) fastmath<contract> : (!fir.box<none>) -> i1
! FIRDialect:           %[[VAL_3:[-0-9A-Za-z._]+]] = fir.if %[[VAL_2]] -> (!fir.heap<!fir.array<?xf32>>) {
! FIRDialect:             %[[VAL_4:[-0-9A-Za-z._]+]] = fir.box_addr %[[VAL_0]] : (!fir.box<!fir.array<?xf32>>) -> !fir.heap<!fir.array<?xf32>>
! FIRDialect:             fir.result %[[VAL_4]] : !fir.heap<!fir.array<?xf32>>
! FIRDialect:           } else {
! FIRDialect:             %[[VAL_5:[-0-9A-Za-z._]+]] = arith.constant 0 : index
! FIRDialect:             %[[VAL_6:[-0-9A-Za-z._]+]]:3 = fir.box_dims %[[VAL_0]], %[[VAL_5]] : (!fir.box<!fir.array<?xf32>>, index) -> (index, index, index)
! FIRDialect:             %[[VAL_7:[-0-9A-Za-z._]+]] = fir.allocmem !fir.array<?xf32>, %[[VAL_6]]#1 {uniq_name = ".copyinout"}
! FIRDialect:             fir.result %[[VAL_7]] : !fir.heap<!fir.array<?xf32>>
! FIRDialect:           }
! FIRDialect:           %[[VAL_8:[-0-9A-Za-z._]+]] = arith.constant 0 : index
! FIRDialect:           %[[VAL_9:[-0-9A-Za-z._]+]]:3 = fir.box_dims %[[VAL_0]], %[[VAL_8]] : (!fir.box<!fir.array<?xf32>>, index) -> (index, index, index)
! FIRDialect:           %[[VAL_10:[-0-9A-Za-z._]+]] = arith.constant false
! FIRDialect:           %[[VAL_11:[-0-9A-Za-z._]+]] = arith.cmpi eq, %[[VAL_2]], %[[VAL_10]] : i1
! FIRDialect:           oss.task firstprivate(%[[VAL_0]] : !fir.box<!fir.array<?xf32>>) shared(%[[VAL_12:[-0-9A-Za-z._]+]] : !fir.heap<!fir.array<?xf32>>) captures(%[[VAL_9]]#1, %[[VAL_11]] : index, i1) {
! FIRDialect:             %[[VAL_13:[-0-9A-Za-z._]+]] = fir.alloca !fir.box<!fir.array<?xf32>> {pinned}
! FIRDialect:             %[[VAL_14:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_12]] : (!fir.heap<!fir.array<?xf32>>) -> !fir.ref<!fir.array<5xf32>>
! FIRDialect:             fir.call @_QPbar_intent_out(%[[VAL_14]]) fastmath<contract> : (!fir.ref<!fir.array<5xf32>>) -> ()
! FIRDialect:             fir.if %[[VAL_11]] {
! FIRDialect:               %[[VAL_15:[-0-9A-Za-z._]+]] = fir.shape %[[VAL_9]]#1 : (index) -> !fir.shape<1>
! FIRDialect:               %[[VAL_16:[-0-9A-Za-z._]+]] = fir.embox %[[VAL_12]](%[[VAL_15]]) : (!fir.heap<!fir.array<?xf32>>, !fir.shape<1>) -> !fir.box<!fir.array<?xf32>>
! FIRDialect:               fir.store %[[VAL_0]] to %[[VAL_13]] : !fir.ref<!fir.box<!fir.array<?xf32>>>
! FIRDialect:               %[[VAL_17:[-0-9A-Za-z._]+]] = fir.address_of(@_QQcl.8f2d0f6342c0c913c244b419469ae9a0) : !fir.ref<!fir.char<1,66>>
! FIRDialect:               %[[VAL_18:[-0-9A-Za-z._]+]] = arith.constant 16 : i32
! FIRDialect:               %[[VAL_19:[-0-9A-Za-z._]+]] = arith.constant true
! FIRDialect:               %[[VAL_20:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_13]] : (!fir.ref<!fir.box<!fir.array<?xf32>>>) -> !fir.ref<!fir.box<none>>
! FIRDialect:               %[[VAL_21:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_16]] : (!fir.box<!fir.array<?xf32>>) -> !fir.box<none>
! FIRDialect:               %[[VAL_22:[-0-9A-Za-z._]+]] = fir.convert %[[VAL_17]] : (!fir.ref<!fir.char<1,66>>) -> !fir.ref<i8>
! FIRDialect:               %[[VAL_23:[-0-9A-Za-z._]+]] = fir.call @_FortranACopyOutAssign(%[[VAL_20]], %[[VAL_21]], %[[VAL_19]], %[[VAL_22]], %[[VAL_18]]) fastmath<contract> : (!fir.ref<!fir.box<none>>, !fir.box<none>, i1, !fir.ref<i8>, i32) -> none
! FIRDialect:               fir.freemem %[[VAL_12]] : !fir.heap<!fir.array<?xf32>>
! FIRDialect:             }
! FIRDialect:             oss.terminator
! FIRDialect:           }
! FIRDialect:           oss.taskwait
! FIRDialect:           return
! FIRDialect:         }

! FIRDialect-LABEL:   func.func @_QPbar_intent_out(
! FIRDialect-SAME:                                 %[[VAL_0:[-0-9A-Za-z._]+]]: !fir.ref<!fir.array<5xf32>> {fir.bindc_name = "x"}) {
! FIRDialect:           return
! FIRDialect:         }
! FIRDialect:         func.func private @_FortranAIsContiguous(!fir.box<none>) -> i1 attributes {fir.runtime}
! FIRDialect:         func.func private @_FortranAAssignTemporary(!fir.ref<!fir.box<none>>, !fir.box<none>, !fir.ref<i8>, i32) -> none attributes {fir.runtime}

! FIRDialect-LABEL:   fir.global internal @_QQcl.8f2d0f6342c0c913c244b419469ae9a0 constant : !fir.char<1,66> {
! FIRDialect:           %[[VAL_0:[-0-9A-Za-z._]+]] = fir.string_lit "/home/rpenacob/llvm-mono/flang/test/OmpSs/Lower/FIR/copyinout.f90\00"(66) : !fir.char<1,66>
! FIRDialect:           fir.has_value %[[VAL_0]] : !fir.char<1,66>
! FIRDialect:         }
! FIRDialect:         func.func private @_FortranACopyOutAssign(!fir.ref<!fir.box<none>>, !fir.box<none>, i1, !fir.ref<i8>, i32) -> none attributes {fir.runtime}

